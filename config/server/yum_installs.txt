#!/bin/bash

sudo su -

######################################################
#			some basic tool installs
######################################################
echo "Installing bind utils";
echo "";
echo "";
yum -y install bind-utils sendmail sendmail-cf


######################################################
#			httpd install
######################################################
echo "Installing Apache Server";
echo "";
echo "";
yum -y install httpd

echo "Configuring SSL";
echo "";
echo "";
yum -y install mod_ssl openssl

# Generate private key 
openssl genrsa -out ca.key 1024 

# Generate CSR 
openssl req -new -key ca.key -out ca.csr

# Generate Self Signed Key
openssl x509 -req -days 365 -in ca.csr -signkey ca.key -out ca.crt

# Copy the files to the correct locations
cp ca.crt /etc/pki/tls/certs
cp ca.key /etc/pki/tls/private/ca.key
cp ca.csr /etc/pki/tls/private/ca.csr

echo "Configuring HTTP passwords";
echo "";
echo "";
# create the new htpassword file
mkdir /home/secure
htpasswd -c /home/secure/password httpadmin

# make it readable by apache
chown apache:apache /home/secure/password
chmod 0660 /home/secure/password


######################################################
#			mysql install
######################################################

echo "Installing mysql";
echo "";
echo "";
yum -y install mysql-server mysql
/etc/init.d/mysqld start

# add to chkconfig so starts on reboot
chkconfig --add mysqld
chkconfig --level 345 mysqld on

(
  echo "USE mysql;"
  echo "set password for 'root'@'localhost' = password('password');" >&2
  echo "set password for 'root'@'%' = password ('password');" >&2
  echo "FLUSH PRIVILEGES;" 
  sleep 5
  echo "UNLOCK  tables;" 
) | mysql ${ARGUMENTS}


######################################################
#			php install
######################################################
echo "Installing PHP";
echo "";
echo "";

yum -y install php php-mysql php-gd php-imap php-ldap php-mysql php-odbc php-pear php-xml php-curl php-xmlrpc php-mcrypt

echo "<?php phpinfo(); ?>" > /var/www/html/index.php


#######################################################
#			git install
######################################################

echo "Installing git";
echo "";
echo "";
yum -y install git

#######################################################
#			java6 install
######################################################

# Download oracle java 6 jdk binary installer from 
# http://www.oracle.com/technetwork/java/javasebusiness/downloads/java-archive-downloads-javase6-419409.html
echo "Installing Oracle Java 6";
echo "";
echo "";
chmod +x jdk-6u*
./jdk-6u*

echo 'export JAVA_HOME=/usr/java/jdk1.6.0_45' >> /etc/profile.d/custom.sh 

alternatives --install /usr/bin/java java /usr/java/jdk1.6.0_45/bin/java 20000
alternatives --install /usr/bin/javaws javaws /usr/java/jdk1.6.0_45/bin/javaws 20000
alternatives --install /usr/bin/javac javac /usr/java/jdk1.6.0_45/bin/javac 20000
alternatives --install /usr/bin/jar jar /usr/java/jdk1.6.0_45/bin/jar 20000
alternatives --install /usr/bin/javap javap /usr/java/jdk1.6.0_45/bin/javap 20000
alternatives --install /usr/bin/jarsigner jarsigner /usr/java/jdk1.6.0_45/bin/jarsigner 20000
alternatives --install /usr/bin/javadoc javadoc /usr/java/jdk1.6.0_45/bin/javadoc 20000

#######################################################
#			maven install
######################################################

echo "Installing Apache Maven";
echo "";
echo "";
cd /usr/share
wget ftp://mirror.reverse.net/pub/apache/maven/maven-3/3.0.5/binaries/apache-maven-3.0.5-bin.tar.gz
unzip apache-maven-3.0.5-bin.tar.gz
ln -s /usr/share/apache-maven-3.0.5/bin/mvn /usr/bin/mvn
rm apache-maven-3.0.5-bin.tar.gz 

#######################################################
#			tomcat install
######################################################

echo "Installing Apache Tomcat 6";
echo "";
echo "";
cd ~iplant
curl -O http://mirror.nexcess.net/apache/tomcat/tomcat-6/v6.0.36/bin/apache-tomcat-6.0.36.zip
unzip apache-tomcat-6.0.36.zip
echo 'export CATALINA_HOME=/usr/local/www/apache-tomcat-6.0.36' >> /etc/profile.d/custom.sh 

/sbin/chkconfig --add tomcat
/sbin/chkconfig --level 345 tomcat on

#######################################################
#			globus install
######################################################

echo "Installing Globus Toolkit";
echo "";
echo "";
curl -O http://www.globus.org/ftppub/gt5/5.2/5.2.0/installers/repo/Globus-repo-config.centos-6-1.noarch.rpm
rpm -ivh Globus-repo-config.centos-6-1.noarch.rpm
yum groupinstall globus-data-management-client
yum groupinstall globus-gridftp
yum -y install myproxy


######################################################
#			bump tcp window size
######################################################

echo "Increasing tcp window size";
echo "";
echo "";
echo '32768 1048576 4194304' > /proc/sys/net/ipv4/tcp_wmem
echo '32768 1048576 4194304' > /proc/sys/net/ipv4/tcp_rmem

######################################################
#			Restart HTTPD
######################################################

# give apache permission to do it's thing
chown -R apache:apache /var/www/html/

# setup the server to restart when the system boots
/sbin/chkconfig --add httpd
/sbin/chkconfig --level 345 httpd on

# fire up the server
/etc/init.d/httpd restart

######################################################
#           Beanstalkd
######################################################
 
# give apache permission to do it's thing
yum -y install beanstalkd
 
# setup the server to restart when the system boots
/sbin/chkconfig --add beanstalkd
/sbin/chkconfig --level 345 beanstalkd on
 
# fire up the server
service beanstalkd start